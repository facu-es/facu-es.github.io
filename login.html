<!DOCTYPE html>
<html lang="es">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>eMercado - Todo lo que busques está aquí</title>

  <link href="https://fonts.googleapis.com/css?family=Raleway:300,300i,400,400i,700,700i,900,900i" rel="stylesheet">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/styles.css" rel="stylesheet">
</head>

<body>
  <main class="mt-5 login-register-background">
    <div class="container">
      <section class="vh-90">
        <div class="container py-5 h-90">
          <div class="row d-flex align-items-center justify-content-center h-90">
            <div class="col-md-8 col-lg-7 col-xl-6">
              <img src="img/login.png" class="img-fluid" alt="Logo de eMercado">
            </div>
            <div class="col-md-7 col-lg-5 col-xl-5 offset-xl-1">
              <h3 class="mb-5">Inicio de sesión</h3>

              <!-- Nombre de usuario -->
              <input type="text" placeholder="Nombre de usuario" id="nombre-usuario"
                class="form-control form-control-lg mb-4">

              <!-- Contraseña -->
              <input type="password" placeholder="Contraseña" id="contra-usuario"
                class="form-control form-control-lg mb-4">

              <!-- Casilla de recuerdame -->
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault">
                <label class="form-check-label" for="flexSwitchCheckDefault">Dejar mi sesion iniciada</label>
              </div>

              <!-- Boton de envío -->
              <button type="button" class="btn btn-primary btn-lg btn-block w-100 mb-4" id="iniciar-sesion">Iniciar
                sesión</button>

              <!-- Boton de registro -->
              <a href="register.html" class="btn btn-secondary btn-lg w-100">Quiero registrar una cuenta</a>

              <!-- Funcion aun no implementada -->
              <!--
              <div class="divider d-flex align-items-center my-4">
                <span>O</span>
                <span class="divider-line"></span>
              </div>

              <div class="mx-3 my-2 py-2 bordert">
                <button type="button" class="btn btn-light btn-outline-secondary w-100" id="inicia-con-google"> <img class="logos-login"
                    src="img/logo-google.png" alt="Logo de Google"> Inicia con Google</button>
              </div>
              -->
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>
  <footer class="text-muted">
    <div class="container">
      <!--
      <p class="float-end">
        <a href="#">Volver arriba</a>
      </p>
       -->
      <p>Este sitio forma parte de <a href="https://jovenesaprogramar.edu.uy/" target="_blank">Jovenes a Programar</a> -
        2022</p>
      <p>Clickea <a target="_blank" href="Letra.pdf">aquí</a> para descargar la letra del obligatorio.</p>
    </div>
  </footer>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"
    integrity="sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="module">
    // Importa scripts de Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-app.js";
    // import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-analytics.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-auth.js";
    import { getDatabase, set, ref, child, get, update, remove } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-database.js";

    // Inicializa configuracion de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCQGRFacISlyqP8jORHOMbNZnbP_w_5FqE",
      authDomain: "ecommerce-jap-2022.firebaseapp.com",
      databaseURL: "https://ecommerce-jap-2022-default-rtdb.firebaseio.com",
      projectId: "ecommerce-jap-2022",
      storageBucket: "ecommerce-jap-2022.appspot.com",
      messagingSenderId: "896723081658",
      appId: "1:896723081658:web:1f50791b2b4a7a7ac12583",
      measurementId: "G-ZZS723TP0W"
    };

    // Inicializa Firebase (aplicacion y acceso a base de datos en tiempo real y login con Google)
    const app = initializeApp(firebaseConfig);
    // const analytics = getAnalytics(app);
    const db = getDatabase();

    // Guarda los elementos del formulario
    const nombreUsuario = document.getElementById('nombre-usuario');
    const contraUsuario = document.getElementById('contra-usuario');
    const botonSesionInciada = document.getElementById('flexSwitchCheckDefault');
    const botonIniciarSesion = document.getElementById('iniciar-sesion');
    const botonIniciaConGoogle = document.getElementById('inicia-con-google');

    function validaCamposFormulario() {
      // Definen las constantes de expresion regular que deben cumplir los datos ingresados
      const usuarioRegEx = /^[a-zA-Z0-9]{5,}$/;

      // Si el nombre de usuario no cumple con la expresion regular, muestra un mensaje de error
      if (!usuarioRegEx.test(nombreUsuario.value)) {
        alert('El nombre de usuario debe ser de al menos 5 caracteres y solo puede contener caracteres alfanumericos');
        return false;
      }
      // Si la contraseña no cumple con la expresion regular, muestra un mensaje de error
      if (!contraUsuario.value) {
        alert('La contraseña no puede estar vacía');
        return false;
      }

      return true;
    }

    // Funcion para inicio de sesion desde base de datos de Firebase
    function autenticarUsuario() {
      // Continua solo si los campos son validos
      if (!validaCamposFormulario()) {
        return;
      };
      const referenciaBD = ref(db);

      get(child(referenciaBD, "ListadoUsuarios/" + nombreUsuario.value)).then((intento) => {
        if (intento.exists()) {
          let contraEnBD = decifrarContra(intento.val().contra);
          if (contraEnBD == contraUsuario.value) {
            iniciarSesion(intento.val());
            window.location.href = "index.html";
          }
          else {
            alert("Contraseña incorrecta");
          }
        }
        else {
          alert("Usuario no registrado");
        }
      });
    }

    // Funcion para descifrar una contraseña utilizando AES
    function decifrarContra(contraEnBD) {
      var contraDescifrada = CryptoJS.AES.decrypt(contraEnBD, contraUsuario.value);
      return contraDescifrada.toString(CryptoJS.enc.Utf8);
    }

    // Funcion para guardar en almacenamiento local o en almacenamiento de sesion el usuario logueado
    function iniciarSesion(usuarioIniciado) {
      if (!botonSesionInciada.checked) {
        sessionStorage.setItem('usuario', JSON.stringify(usuarioIniciado));
      }
      else {
        localStorage.setItem('mantenersesioniniciada', true);
        localStorage.setItem('usuario', JSON.stringify(usuarioIniciado));
      }
    }

    // Escucha de evento de click sobre el boton de login
    botonIniciarSesion.addEventListener('click', autenticarUsuario);
  </script>
</body>

</html>