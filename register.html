<!DOCTYPE html>
<html lang="es">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>eMercado - Todo lo que busques está aquí</title>

  <link href="https://fonts.googleapis.com/css?family=Raleway:300,300i,400,400i,700,700i,900,900i" rel="stylesheet">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/styles.css" rel="stylesheet">
</head>

<body>
  <main class="mt-5 login-register-background">
    <div class="container">
      <section class="vh-90">
        <div class="container py-5 h-90">
          <div class="row d-flex align-items-center justify-content-center h-90">
            <div class="col-md-8 col-lg-7 col-xl-6">
              <img src="img/login.png" class="img-fluid" alt="Logo de eMercado">
            </div>
            <div class="col-md-7 col-lg-5 col-xl-5 offset-xl-1">
              <h3 class="mb-5">Registro de usuario</h3>
              <!-- Nombre completo -->
              <input type="text" placeholder="Nombre completo" id="nombre-registro" class="form-control form-control-lg mb-4">

              <!-- Correo electronico -->
              <input type="text" placeholder="Correo electronico" id="correo-registro" class="form-control form-control-lg mb-4">

              <!-- Nombre de usuario -->
              <input type="text" placeholder="Usuario" id="usuario-registro" class="form-control form-control-lg mb-4">

              <!-- Contraseña -->
              <input type="password" placeholder="Contraseña" id="contra-registro" class="form-control form-control-lg mb-4">

              <!-- Boton de envío -->
              <button type="text" id="registrarse" class="btn btn-primary btn-lg btn-block w-100 mb-4">Registrarse</button>
              <a href="login.html" class="btn btn-secondary btn-lg w-100"> ¿Ya tienes una cuenta?</a>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>
  <footer class="text-muted">
    <div class="container">
      <p class="float-end">
      <!--
        <a href="#">Volver arriba</a>
      </p>
      -->
      <p>Este sitio forma parte de <a href="https://jovenesaprogramar.edu.uy/" target="_blank">Jovenes a Programar</a> -
        2022</p>
      <p>Clickea <a target="_blank" href="Letra.pdf">aquí</a> para descargar la letra del obligatorio.</p>
    </div>
  </footer>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"
    integrity="sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="module">
    // Importa scripts de Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-app.js";
    // import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-analytics.js";
    // import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-auth.js";
    import { getDatabase, set, ref, child, get, update, remove } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-database.js";

    // Inicializa configuracion de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCQGRFacISlyqP8jORHOMbNZnbP_w_5FqE",
      authDomain: "ecommerce-jap-2022.firebaseapp.com",
      databaseURL: "https://ecommerce-jap-2022-default-rtdb.firebaseio.com",
      projectId: "ecommerce-jap-2022",
      storageBucket: "ecommerce-jap-2022.appspot.com",
      messagingSenderId: "896723081658",
      appId: "1:896723081658:web:1f50791b2b4a7a7ac12583",
      measurementId: "G-ZZS723TP0W"
    };

    // Inicializa Firebase (aplicacion y acceso a base de datos en tiempo real)
    const app = initializeApp(firebaseConfig);
    // const analytics = getAnalytics(app);
    const db = getDatabase();

    // Guarda los elementos del formulario
    const nombreRegistro = document.getElementById('nombre-registro');
    const contraRegistro = document.getElementById('contra-registro');
    const nombreUsuarioRegistro = document.getElementById('usuario-registro');
    const correoRegistro = document.getElementById('correo-registro');
    const botonRegistrar = document.getElementById('registrarse');

    // Realiza validaciones del formulario de Registro
    function validaCamposFormulario() {
      // Definen las constantes de expresion regular que deben cumplir los datos ingresados
      const nombreRegEx = /^[a-zA-Z\s]+$/;
      const correoRegEx = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      const usuarioRegEx = /^[a-zA-Z0-9]{5,}$/;

      // Si el nombre completo no cumple con la expresion regular, muestra un mensaje de error
      if (!nombreRegEx.test(nombreRegistro.value)) {
        alert('El nombre completo solo puede contener caracteres alfabeticos y espacios');
        return false;
      }
      // Si el correo electronico no cumple con la expresion regular, muestra un mensaje de error
      if (!correoRegEx.test(correoRegistro.value)) {
        alert('El correo electronico debe ser válido');
        return false;
      }
      // Si el nombre de usuario no cumple con la expresion regular, muestra un mensaje de error
      if (!usuarioRegEx.test(nombreUsuarioRegistro.value)) {
        alert('El nombre de usuario debe ser de al menos 5 caracteres y solo puede contener caracteres alfanumericos');
        return false;
      }
      return true;
    }

    // Funcion de inicio de sesion
    function iniciarSesion(usuario) {
      sessionStorage.setItem('usuario', JSON.stringify(usuario));
      window.location.href = 'index.html';
    }

    // Cifra la contraseña con el algoritmo de cifrado AES
    function cifrarContra() {
      const cifrada = CryptoJS.AES.encrypt(contraRegistro.value, contraRegistro.value);
      return cifrada.toString();
    }

    // Registra el usuario en la base de datos de Firebase
    function registrarUsuario() {
      // Continua solo si los campos son validos
      if (!validaCamposFormulario()) {
        return;
      };
      // 
      const referenciaBD = ref(db);

      // Busca un elemento con el nombre de usuario ingresado, si existe alerta al usuario y no registra
      get(child(referenciaBD, "UserList/" + nombreUsuarioRegistro.value)).then((intento) => {
        if (intento.exists()) {
          alert('El nombre de usuario ya existe intente con otro');
        }
        // Crea el usuario en la base de datos
        else {
          set(ref(db, "UserList/" + nombreUsuarioRegistro.value),
            {
              nombre_completo: nombreRegistro.value,
              correo: correoRegistro.value,
              nombre_usuario: nombreUsuarioRegistro.value,
              contra: cifrarContra()
            })
            // Inicia sesion con el usuario registrado
            .then(() => {
              alert('Usuario registrado correctamente');
              iniciarSesion({
                nombre_completo: nombreRegistro.value,
                correo: correoRegistro.value,
                nombre_usuario: nombreUsuarioRegistro.value,
                contra: cifrarContra()
              });
            })
            // En caso de error alerta al usuario con el codigo de error
            .catch((error) => {
              alert(error.message);
            })
        }
      });
    }

    botonRegistrar.addEventListener('click', registrarUsuario);

  </script>
</body>

</html>